name: MailHub SLA Alerts

on:
  schedule:
    # 毎15分実行（重複防止が24hなのでSlackは荒れにくい）
    - cron: "*/15 * * * *"
  workflow_dispatch:
    # 手動実行も可能
    inputs:
      environment:
        description: "Environment (staging or production)"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

concurrency:
  group: mailhub-alerts-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run-alerts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "env=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            # スケジュール実行の場合はproduction
            echo "env=production" >> $GITHUB_OUTPUT
          fi

      - name: Set URL
        id: url
        run: |
          if [ "${{ steps.env.outputs.env }}" == "production" ]; then
            echo "url=${{ secrets.MAILHUB_PROD_URL }}" >> $GITHUB_OUTPUT
          else
            echo "url=${{ secrets.MAILHUB_STAGING_URL }}" >> $GITHUB_OUTPUT
          fi

      - name: Health check
        run: |
          curl --fail --retry 3 --max-time 20 \
            "${{ steps.url.outputs.url }}/api/health" || exit 1

      - name: Run SLA alerts
        run: |
          RESPONSE=$(curl --fail --retry 3 --max-time 20 \
            -H "Authorization: Bearer ${{ secrets.MAILHUB_ALERTS_SECRET }}" \
            "${{ steps.url.outputs.url }}/api/mailhub/alerts/run?scope=all")
          
          echo "Response: $RESPONSE"
          
          # truncatedがtrueの場合は警告を出す（exit codeは0のまま）
          if echo "$RESPONSE" | grep -q '"truncated":true'; then
            echo "⚠️ Warning: Alert truncated (limit reached)"
          fi




